#############################
# ZTE Router Remote Logging #
# Analytics-Ready Pipeline  #
#############################
# Place in: /etc/rsyslog.d/30-router.conf
# Optimized for ZTE F670L router logs

#############################
# TEMPLATE WITH METADATA
#############################
template(name="RouterJSON" type="list") {
  constant(value="{")
  constant(value="\"@timestamp\":\"")
    property(name="timereported" dateFormat="rfc3339")
  constant(value="\",\"@generated\":\"")
    property(name="timegenerated" dateFormat="rfc3339")
  constant(value="\",\"host\":\"")
    property(name="hostname")
  constant(value="\",\"source_ip\":\"")
    property(name="fromhost-ip")
  constant(value="\",\"severity\":\"")
    property(name="syslogseverity-text")
  constant(value="\",\"facility\":\"")
    property(name="syslogfacility-text")
  constant(value="\",\"program\":\"")
    property(name="programname")
  constant(value="\",\"inputname\":\"")
    property(name="inputname")
  constant(value="\",\"subsystem\":\"")
    property(name="$!subsystem")
  constant(value="\",\"event_type\":\"")
    property(name="$!event_type")
  constant(value="\",\"message\":\"")
    property(name="msg" format="json")
  constant(value="\"}\n")
}

#############################
# RULESET
#############################
ruleset(name="router_ruleset") {

  # ---- Filter kernel/driver noise FIRST ----
  # Only filter kernel logs AND specific known garbage tags
  if (($syslogfacility-text == "kern" and $programname == "kernel") or
      $syslogtag == "HT" or
      $syslogtag == "D2:" or
      $msg == "") then {
    stop
  }

  # ---- Set defaults ----
  set $!subsystem = "unknown";
  set $!event_type = "unknown";

  # ========================================
  # DHCP - Stateful IPv4 address management
  # ========================================
  if ($msg contains "DHCPS:" or
      $msg contains "DHCP4S:") then {
    set $!subsystem = "dhcp";

    if ($msg contains "Recv Packet" or $msg contains "msgtype") then {
      set $!event_type = "request";
    }
    else if ($msg contains "Send Pkt") then {
      set $!event_type = "response";
    }
    else {
      set $!event_type = "ipv4";
    }
  }

  # ========================================
  # DHCP Record Lookups
  # ========================================
  else if ($programname == "record" or
           $msg contains "Dhcps Get Query Record") then {
    set $!subsystem = "dhcp";
    set $!event_type = "query";
  }

  # ========================================
  # DHCPv6 - IPv6 address management
  # ========================================
  else if ($msg contains "DHCP6S:") then {
    set $!subsystem = "dhcp";

    if ($msg contains "receive packet") then {
      set $!event_type = "ipv6_request";
    }
    else if ($msg contains "send dhcp6msg") then {
      set $!event_type = "ipv6_response";
    }
    else {
      set $!event_type = "ipv6";
    }
  }

  # ========================================
  # SLAAC - IPv6 autoconfiguration
  # ========================================
  else if ($msg contains "slaacFindByIFName" or
           $programname == "slaac" or
           $msg contains "dns not OK, but M=0, O=0") then {
    set $!subsystem = "ipv6";
    set $!event_type = "slaac_error";
  }

  # ========================================
  # WiFi Client Kickoff - Band steering
  # ========================================
  else if ($programname == "<zhuqing>" or
           $msg contains "kickoff sta:") then {
    set $!subsystem = "wifi";
    set $!event_type = "client_kickoff";
  }

  # ========================================
  # WiFi BTM - Band Transition Management
  # ========================================
  else if ($programname == "BTM" or
           $msg contains "BTM REPORT") then {
    set $!subsystem = "wifi";
    set $!event_type = "btm_report";
  }

  # ========================================
  # WiFi STA - Station reports
  # ========================================
  else if ($programname == "STA" or
           $programname == "REPORT_STASTATUS" or
           $msg contains "LEAVE REPORT" or
           $msg contains "can't find sta") then {
    set $!subsystem = "wifi";
    set $!event_type = "sta_report";
  }

  # ========================================
  # WiFi Topology - Association/Roaming
  # ========================================
  else if ($msg contains "TOPOLOGY NOTIFY" or
           $msg contains "ROAM INFO") then {
    set $!subsystem = "wifi";

    if ($msg contains "associate") then {
      set $!event_type = "association";
    }
    else if ($msg contains "ROAM INFO") then {
      set $!event_type = "roaming";
    }
    else {
      set $!event_type = "topology";
    }
  }

  # ========================================
  # WiFi General - Radio/Client management
  # ========================================
  else if ($msg contains "AddBAReq" or
           $msg contains "wdev" or
           $msg contains "SSID" or
           $msg contains "802.11" or
           $msg contains "MaxCap:VHT" or
           $msg contains "bSupportMWDS" or
           $msg contains "WIFI" or
           $msg contains "WLANAD") then {
    set $!subsystem = "wifi";
    set $!event_type = "client";
  }

  # ========================================
  # WAN/PPP - ISP connection management
  # ========================================
  else if ($programname == "PPP" or
           $msg contains "pppd:" or
           $msg contains "PAP authentication" or
           $msg contains "IPCP up" or
           $msg contains "IPV6CP up" or
           $msg contains "local/remote IP" or
           $msg contains "multicast wan" or
           $msg contains "Connect time") then {
    set $!subsystem = "wan";

    if ($msg contains "Authentication success" or
        $msg contains "authentication failed") then {
      set $!event_type = "ppp_auth";
    }
    else if ($msg contains "IPCP up" or $msg contains "IPV6CP up") then {
      set $!event_type = "ppp_link_up";
    }
    else if ($msg contains "local/remote IP") then {
      set $!event_type = "session_start";
    }
    else {
      set $!event_type = "connection";
    }
  }

  # ========================================
  # Authentication - Web UI login/logout
  # ========================================
  else if ($syslogfacility-text == "auth" and
           ($msg contains "login success" or
            $msg contains "logout success" or
            $msg contains "authenticated ok" or
            $msg contains "Web user")) then {
    set $!subsystem = "auth";

    if ($msg contains "login success") then {
      set $!event_type = "login";
    }
    else if ($msg contains "logout success") then {
      set $!event_type = "logout";
    }
    else {
      set $!event_type = "session";
    }
  }

  # ========================================
  # System Timeouts - Protocol communication
  # ========================================
  else if ($programname == "delay" or
           $msg contains "resp timeout" or
           $msg contains "u16MsgType" or
           $msg contains "u16MsgId") then {
    set $!subsystem = "system";
    set $!event_type = "timeout";
  }

  # ========================================
  # System Process Control
  # ========================================
  else if ($programname == "call" or
           $msg contains "PcStopProgram" or
           $msg contains "get_ap_list" or
           $msg contains "GetTagParam failed") then {
    set $!subsystem = "system";
    set $!event_type = "process_control";
  }

  # ========================================
  # System - Internal management framework
  # ========================================
  else if ($programname == "RunPCB" or
           $msg contains "CMAPI" or
           $msg contains "CPUMEMINFO" or
           $msg contains "cJson_mgr" or
           $msg contains "function failed") then {
    set $!subsystem = "system";
    set $!event_type = "internal";
  }

  # ========================================
  # System - Factory Test / Timer Events
  # ========================================
  else if ($programname == "**Timer7Event" or
           $msg contains "factorytest") then {
    set $!subsystem = "system";
    set $!event_type = "factory_test";
  }

  # ========================================
  # System - Configuration Errors
  # ========================================
  else if ($programname == "get" or
           $programname == "parameter" or
           $msg contains "get view failed" or
           $msg contains "parameter is NULL" or
           $msg contains "interface is not found") then {
    set $!subsystem = "system";
    set $!event_type = "config_error";
  }

  # ========================================
  # System - Adaptor/IPC Errors
  # ========================================
  else if ($programname == "Adaptor" or
           $programname == "iRetId(105)" or
           $msg contains "is not found in g_tCmRetHead" or
           $msg contains "OBJ_UPLINK_CONF_ID") then {
    set $!subsystem = "system";
    set $!event_type = "ipc_error";
  }

  # ========================================
  # System - Device Manager
  # ========================================
  else if ($programname == "success" or
           $msg contains "get Dev PhyPort from dev_mgr") then {
    set $!subsystem = "system";
    set $!event_type = "device_mgr";
  }

  # ========================================
  # Network Config Errors - Bridge issues
  # ========================================
  else if ($programname == "can't" or
           $programname == "not" or
           $msg contains "be same with br0" or
           $msg contains "IFName:br0" or
           $msg contains "message repeated") then {
    set $!subsystem = "network";
    set $!event_type = "config_error";
  }

  # ========================================
  # System Boot/Reboot
  # ========================================
  else if ($programname == "reboot" or
           $programname == "fzj_debug" or
           $msg contains "The system will reboot" or
           $msg contains "Rcv the dev_mgr reboot msg" or
           $msg contains "SSEND [0X9B02]" or
           $msg contains "error for send syn msg") then {
    set $!subsystem = "system";
    set $!event_type = "boot";
  }

  # ========================================
  # TR-069/CWMP - ISP remote management
  # ========================================
  else if ($msg contains "TR-069" or
           $msg contains "CWMP" or
           $msg contains "ACS" or
           $msg contains "ScheduleInform" or
           $msg contains "Inform sent") then {
    set $!subsystem = "tr069";
    set $!event_type = "management";
  }

  # ========================================
  # Firewall/Security - Netfilter logs
  # ========================================
  else if ($msg contains "DROP IN=" or
           $msg contains "REJECT" or
           $msg contains "iptables" or
           $msg contains "firewall" or
           $msg contains "blocked") then {
    set $!subsystem = "security";
    set $!event_type = "firewall";
  }

  # ========================================
  # DNS - Name resolution
  # ========================================
  else if ($msg contains "DNS" or
           $msg contains "dnsmasq" or
           $msg contains "named" or
           $msg contains "resolver") then {
    set $!subsystem = "dns";
    set $!event_type = "query";
  }

  # ========================================
  # QoS - Traffic shaping
  # ========================================
  else if ($msg contains "QoS" or
           $msg contains "bandwidth" or
           $msg contains "priority" or
           $msg contains "class=") then {
    set $!subsystem = "qos";
    set $!event_type = "traffic";
  }

  # ========================================
  # USB/Storage - External devices
  # ========================================
  else if ($msg contains "USB" or
           $msg contains "usb" or
           $msg contains "storage" or
           $msg contains "high-speed USB device") then {
    set $!subsystem = "usb";
    set $!event_type = "device";
  }

  # ========================================
  # VoIP/SIP - Voice services
  # ========================================
  else if ($msg contains "SIP" or
           $msg contains "REGISTER" or
           $msg contains "VoIP" or
           $msg contains "voice") then {
    set $!subsystem = "voip";
    set $!event_type = "call";
  }

  # ========================================
  # LAN/Bridge - Local network
  # ========================================
  else if ($msg contains "LAN" or
           $msg contains "bridge" or
           $msg contains "br0" or
           $msg contains "br-lan") then {
    set $!subsystem = "lan";
    set $!event_type = "network";
  }

  # ---- Write to file ----
  action(
    type="omfile"
    file="/var/log/router/router.log"
    template="RouterJSON"
  )

  # ---- Write to Docker port ----
  action(
    type="omfwd"
    target="127.0.0.1"
    port="10514"
    protocol="tcp"
    template="RouterJSON"
    action.resumeRetryCount="-1"
    queue.type="linkedList"
    queue.size="100000"
    queue.filename="python_ingest_queue"
   )
}

#############################
# APPLY RULESET TO ROUTER IP
#############################
if ($fromhost-ip == "192.168.1.1") then {
  call router_ruleset
  stop
}
